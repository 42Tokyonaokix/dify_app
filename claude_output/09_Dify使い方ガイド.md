# Dify 使い方ガイド

## Difyとは

Difyは**ノーコードでAIアプリを作れるプラットフォーム**。
ChatGPT、Claude、Geminiなどを使ったアプリを、プログラミングなしで構築できる。

---

## 基本概念

### 4つのアプリタイプ

| タイプ | 説明 | 用途例 |
|-------|------|--------|
| **チャットボット** | 会話形式のAI | カスタマーサポート、FAQ |
| **テキスト生成** | 入力→出力の単発処理 | 文章要約、翻訳 |
| **エージェント** | ツールを使って自律的に動くAI | 検索+回答、API呼び出し |
| **ワークフロー** | 複数ステップを連結 | 複雑な業務自動化 |

### 重要な機能

| 機能 | 説明 |
|-----|------|
| **プロンプト** | AIへの指示文 |
| **変数** | ユーザー入力を受け取る |
| **ナレッジベース** | 独自データをAIに読ませる（RAG） |
| **ツール** | 外部APIやサービスとの連携 |

---

## 初回セットアップ

### 1. アクセス
```
http://localhost
```

### 2. 管理者アカウント作成
- メールアドレス
- パスワード
- 名前

### 3. モデル設定（重要）
設定 → モデルプロバイダー → OpenAI または Claude を設定

```
OpenAI APIキー: sk-proj-xxxxx
```

---

## 最初のアプリを作る（チャットボット）

### Step 1: 新規作成
1. 「スタジオ」をクリック
2. 「アプリを作成」をクリック
3. 「最初から作成」を選択
4. 「チャットボット」を選択
5. アプリ名を入力（例：「テスト Bot」）

### Step 2: プロンプト設定
「オーケストレーション」タブで以下を入力：

```
あなたは親切なアシスタントです。
ユーザーの質問に日本語で丁寧に回答してください。
```

### Step 3: テスト
右側のプレビューパネルで会話をテスト

### Step 4: 公開
「公開する」ボタンをクリック

---

## ワークフローを作る

### Step 1: 新規作成
1. 「アプリを作成」→「最初から作成」
2. 「ワークフロー」を選択

### Step 2: ノードを追加

#### 基本ノード
| ノード | 説明 |
|-------|------|
| **開始** | ワークフローの入口（入力変数を定義） |
| **LLM** | AIモデルを呼び出す |
| **終了** | 最終出力を返す |

#### 便利なノード
| ノード | 説明 |
|-------|------|
| **HTTPリクエスト** | 外部APIを呼ぶ |
| **コード** | Python/JavaScriptを実行 |
| **条件分岐** | IF文のような分岐 |
| **変数代入** | 変数を操作 |
| **テンプレート** | テキストを組み立てる |

### Step 3: ノードを接続
ノード間をドラッグで線を引いて接続

### Step 4: テスト実行
「実行」ボタンでテスト

---

## Email Serviceと連携する

### HTTPリクエストノードの設定

```yaml
URL: http://email-service:8000/emails
メソッド: GET
クエリパラメータ:
  - limit: 5
  - folder: INBOX
```

### ワークフロー例：メール要約Bot

```
[開始] → [HTTPリクエスト] → [LLM] → [終了]
           ↓                   ↓
    メール取得            メール内容を要約
```

#### LLMノードのプロンプト例
```
以下のメール一覧を日本語で要約してください：

{{#httpRequest.body#}}
```

---

## ナレッジベース（RAG）

### 作成手順
1. 「ナレッジ」→「ナレッジを作成」
2. ファイルをアップロード（PDF、TXT、Markdown等）
3. チャンク設定（デフォルトでOK）
4. インデックス作成を待つ

### アプリと連携
1. アプリの「コンテキスト」セクション
2. 「追加」→ナレッジを選択
3. 取得設定を調整（Top K、スコア閾値）

---

## ツール連携

### 組み込みツール
- Google検索
- Wikipedia
- 天気API
- Webスクレイピング

### カスタムツール
1. 「ツール」→「カスタム」→「作成」
2. OpenAPI仕様（Swagger）を入力
3. 認証設定（APIキーなど）

### Email Serviceをツール化
```yaml
openapi: 3.0.0
info:
  title: Gmail Email Service
  version: 1.0.0
servers:
  - url: http://email-service:8000
paths:
  /emails:
    get:
      summary: メール取得
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
        - name: folder
          in: query
          schema:
            type: string
            default: INBOX
```

---

## 公開・運用

### 公開オプション
| 方法 | 説明 |
|-----|------|
| **Webアプリ** | URLを共有 |
| **埋め込み** | iframeでサイトに埋め込み |
| **API** | RESTful APIとして呼び出し |

### API呼び出し例
```bash
curl -X POST 'http://localhost/v1/chat-messages' \
  -H 'Authorization: Bearer {api_key}' \
  -H 'Content-Type: application/json' \
  -d '{
    "inputs": {},
    "query": "こんにちは",
    "user": "user-123"
  }'
```

---

## Tips

### プロンプトのコツ
1. **役割を明確に**: 「あなたは〇〇の専門家です」
2. **出力形式を指定**: 「箇条書きで回答してください」
3. **制約を設ける**: 「100文字以内で」

### デバッグ
- 各ノードの出力を「ログ」で確認
- 変数の中身を「変数パネル」で確認

### パフォーマンス
- 不要なノードを減らす
- LLM呼び出し回数を最小化
- キャッシュを活用

---

## よくある操作

| やりたいこと | 操作 |
|------------|------|
| アプリ複製 | アプリ右上「...」→「複製」 |
| バージョン管理 | 「公開する」→バージョン履歴 |
| 変数追加 | 開始ノード→「+」で変数追加 |
| モデル変更 | LLMノード→モデル選択 |
| ログ確認 | 「ログ」タブ |

---

## 次のステップ

1. 簡単なチャットボットを作ってみる
2. Email Serviceと連携したワークフローを作る
3. ナレッジベースでRAGを試す
4. 本番運用に向けてAPIで連携

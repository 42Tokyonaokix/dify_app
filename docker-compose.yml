services:
  # PostgreSQL - Difyのメインデータベース
  # ユーザー情報、ワークフロー設定、会話履歴などを保存
  db:
    image: postgres:15-alpine
    container_name: dify-db
    restart: always
    environment:
      POSTGRES_USER: dify
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: dify
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ./volumes/db/data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dify"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis - キャッシュとセッション管理
  # API呼び出しのキャッシュ、タスクキューなどに使用
  redis:
    image: redis:7-alpine
    container_name: dify-redis
    restart: always
    volumes:
      - ./volumes/redis/data:/data
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Weaviate - ベクトルデータベース
  # ナレッジベース、RAG（検索拡張生成）機能に使用
  weaviate:
    image: semitechnologies/weaviate:1.19.0
    container_name: dify-weaviate
    restart: always
    volumes:
      - ./volumes/weaviate/data:/var/lib/weaviate
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'none'
      CLUSTER_HOSTNAME: 'node1'
    ports:
      - "8080:8080"

  # Dify API - バックエンドサービス
  # ワークフロー実行、LLM統合、データ処理を担当
  api:
    image: langgenius/dify-api:0.6.13
    container_name: dify-api
    restart: always
    environment:
      # モード設定
      MODE: api

      # シークレットキー
      SECRET_KEY: ${SECRET_KEY}

      # データベース設定
      DB_USERNAME: dify
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: dify

      # Redis設定
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_USE_SSL: 'false'

      # Celeryキュー設定（バックグラウンドタスク用）
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD}@redis:6379/1

      # ベクトルDB設定
      VECTOR_STORE: weaviate
      WEAVIATE_ENDPOINT: http://weaviate:8080
      WEAVIATE_API_KEY: ${WEAVIATE_API_KEY}

      # ストレージ設定（ファイルアップロード用）
      STORAGE_TYPE: local
      STORAGE_LOCAL_PATH: /app/storage

      # CORS設定（フロントエンドからのアクセスを許可）
      CONSOLE_WEB_URL: http://localhost:3000
      CONSOLE_CORS_ALLOW_ORIGINS: http://localhost:3000,http://127.0.0.1:3000
      WEB_API_CORS_ALLOW_ORIGINS: http://localhost:3000,http://127.0.0.1:3000
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./volumes/app/storage:/app/storage
    ports:
      - "5001:5001"

  # Dify Worker - バックグラウンドタスク処理
  # 非同期タスク、長時間実行ジョブを処理
  worker:
    image: langgenius/dify-api:0.6.13
    container_name: dify-worker
    restart: always
    environment:
      MODE: worker
      SECRET_KEY: ${SECRET_KEY}
      DB_USERNAME: dify
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: dify
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_USE_SSL: 'false'
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD}@redis:6379/1
      VECTOR_STORE: weaviate
      WEAVIATE_ENDPOINT: http://weaviate:8080
      WEAVIATE_API_KEY: ${WEAVIATE_API_KEY}
      STORAGE_TYPE: local
      STORAGE_LOCAL_PATH: /app/storage
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./volumes/app/storage:/app/storage

  # Dify Web - フロントエンドUI
  # ブラウザでアクセスするダッシュボード
  web:
    image: langgenius/dify-web:0.6.13
    container_name: dify-web
    restart: always
    environment:
      CONSOLE_API_URL: http://localhost:5001
      APP_API_URL: http://localhost:5001
    ports:
      - "3000:3000"

  # Nginx - リバースプロキシ
  # フロントエンドとAPIを統合してポート80で提供
  nginx:
    image: nginx:alpine
    container_name: dify-nginx
    restart: always
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api
      - web
    ports:
      - "80:80"

  # Email Service - Gmailメール取得API
  # IMAPでメールを取得し、Difyから呼び出し可能なREST APIを提供
  email-service:
    build:
      context: ./email-service
      dockerfile: Dockerfile
    container_name: email-service
    restart: always
    environment:
      GMAIL_EMAIL: ${GMAIL_EMAIL:-your-email@gmail.com}
      GMAIL_APP_PASSWORD: ${GMAIL_APP_PASSWORD:-your-app-password}
      IMAP_SERVER: imap.gmail.com
      IMAP_PORT: 993
    volumes:
      - ./email-service:/app
    ports:
      - "8002:8000"
    depends_on:
      - redis
